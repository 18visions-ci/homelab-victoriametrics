---
- name: Ensure the directory for VictoriaMetrics data exists on NAS
  file:
    path: "{{ victoria_metrics_dir }}"
    state: directory
    owner: victoriametrics
    group: victoriametrics
    mode: '0755'
  become: yes  # Ensure we have elevated privileges to create the directory

- name: Ensure correct ownership of the NFS mount directory (with become)
  file:
    path: "{{ victoria_metrics_dir }}"
    owner: victoriametrics
    group: victoriametrics
    recurse: yes
  become: yes  # Ensure we have elevated privileges to modify ownership

- name: Fix NFS share permissions if needed (temporary fix for UID/GID issues)
  command: chown -R victoriametrics:victoriametrics {{ victoria_metrics_dir }}
  become: yes
  when: ansible_facts['os_family'] == "Debian"  # Check if it's an Ubuntu-based system

- name: Copy the systemd service file for VictoriaMetrics
  copy:
    src: victoriametrics.service  # This is now in the 'files' directory
    dest: /etc/systemd/system/victoriametrics.service
    mode: '0644'  # You can set permissions now, as the file is copied from 'files'

- name: Reload systemd to register the new service
  systemd:
    daemon_reload: yes

- name: Enable and start VictoriaMetrics service
  systemd:
    name: victoriametrics
    state: started
    enabled: yes
